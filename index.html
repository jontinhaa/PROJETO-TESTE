<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydro MPSA | Offline</title>
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="./manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="./assets/leitor.js"></script>

    <style>
        /* ESTILO MANTIDO */
        body { font-family: 'Roboto', sans-serif; background: #F5F7FA; color: #263238; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 480px; padding: 20px; box-sizing: border-box; text-align: center; }
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; border: 1px solid #E0E0E0; }
        .mapa-container { display: flex; width: 100%; height: 120px; border: 2px solid #004B87; border-radius: 6px; overflow: hidden; margin-bottom: 20px; }
        .zona { flex: 1; display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; cursor: pointer; }
        .zona-esquerda { background-color: #0277bd; border-right: 1px solid white; }
        .zona-direita { background-color: #004B87; border-left: 1px solid white; }
        .btn { background: #004B87; color: white; padding: 14px; width: 100%; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-download { background: #388E3C; margin-bottom: 10px; }
        .btn-download:disabled { background: #B0BEC5; }
        video { width: 100%; border-radius: 4px; background: black; margin-top: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <h3>Hydro MPSA - Modo IndexedDB</h3>

        <div id="screen-home">
            <div class="card">
                <p>Armazenamento Seguro de V√≠deo</p>
                <button class="btn btn-download" id="btn-baixar" onclick="iniciarDownloadIndexedDB()">
                    ‚¨á BAIXAR V√çDEOS (BANCO DE DADOS)
                </button>
                <div id="status-txt" style="margin-top:10px; font-size:0.8rem;">Aguardando...</div>
            </div>

            <div class="card">
                <span style="display:block; margin-bottom:10px; color:#004B87; font-weight:bold;">MAPA T√ÅTIL</span>
                <div class="mapa-container">
                    <div class="zona zona-esquerda" onclick="tocarDoBanco('moinho')">MOINHO</div>
                    <div class="zona zona-direita" onclick="tocarDoBanco('peneira')">PENEIRA</div>
                </div>
                <button class="btn" onclick="iniciarScanner()">üì∑ QR CODE</button>
            </div>
        </div>

        <div id="screen-video" class="hidden">
            <div class="card">
                <h2 id="video-title">Player</h2>
                <video id="player" controls controlsList="nodownload"></video>
                <button class="btn" onclick="fecharVideo()">‚¨Ö VOLTAR</button>
            </div>
        </div>
        
        <div id="screen-scanner" class="hidden">
            <div class="card">
                <div id="reader"></div>
                <button class="btn" style="background:#D32F2F" onclick="pararScanner()">CANCELAR</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO DO BANCO DE DADOS (IndexedDB) ---
        const DB_NAME = 'HydroVideoDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'videos';

        // 1. Abre/Cria o Banco
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        // 2. Salva Arquivo no Banco
        async function salvarVideo(id, blob) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.put(blob, id);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        // 3. Recupera Arquivo do Banco
        async function pegarVideo(id) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // --- FUN√á√ÉO DE DOWNLOAD (Salva no IndexedDB) ---
        async function iniciarDownloadIndexedDB() {
            const btn = document.getElementById('btn-baixar');
            const txt = document.getElementById('status-txt');
            
            btn.disabled = true;
            
            // URLs absolutas para evitar erro
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
            const videos = [
                { id: 'moinho', url: baseUrl + 'assets/moinho.mp4' },
                { id: 'peneira', url: baseUrl + 'assets/peneira.mp4' }
            ];

            try {
                for (const item of videos) {
                    txt.innerText = `Baixando ${item.id}...`;
                    
                    // Fetch com Cache Buster
                    const response = await fetch(item.url + "?t=" + Date.now());
                    if (!response.ok) throw new Error(`Erro baixar ${item.id}`);
                    
                    const blob = await response.blob();
                    
                    // SALVA NO BANCO!
                    await salvarVideo(item.id, blob);
                }

                txt.innerText = "V√≠deos Salvos no Banco de Dados! ‚úì";
                txt.style.color = "green";
                btn.innerText = "CONTE√öDO SEGURO ‚úì";
                
            } catch (err) {
                txt.innerText = "Erro: " + err.message;
                txt.style.color = "red";
                btn.disabled = false;
                alert("Falha no download: " + err.message);
            }
        }

        // --- PLAYER (L√™ do IndexedDB e Toca) ---
        async function tocarDoBanco(id) {
            // Normaliza ID vindo do QR Code (ex: 'https://...#moinho' vira 'moinho')
            if (id.includes('moinho')) id = 'moinho';
            else if (id.includes('peneira')) id = 'peneira';
            else { alert("ID desconhecido: " + id); return; }

            const player = document.getElementById('player');
            const title = document.getElementById('video-title');
            
            try {
                // Tenta pegar do banco
                const blob = await pegarVideo(id);
                
                if (!blob) {
                    alert("V√≠deo n√£o encontrado no Banco de Dados! Fa√ßa o download primeiro.");
                    return;
                }

                // Cria URL m√°gica (blob:...)
                const videoURL = URL.createObjectURL(blob);
                
                title.innerText = id.toUpperCase();
                player.src = videoURL;
                
                document.getElementById('screen-home').classList.add('hidden');
                document.getElementById('screen-scanner').classList.add('hidden');
                document.getElementById('screen-video').classList.remove('hidden');
                
                player.play();

            } catch (err) {
                alert("Erro ao abrir v√≠deo: " + err.message);
            }
        }

        function fecharVideo() {
            const player = document.getElementById('player');
            player.pause();
            // Limpa a URL da mem√≥ria para n√£o travar o celular
            if(player.src) URL.revokeObjectURL(player.src);
            player.src = "";
            
            document.getElementById('screen-video').classList.add('hidden');
            document.getElementById('screen-home').classList.remove('hidden');
        }

        // --- SCANNER E OUTROS ---
        // (Mantido simples para focar no v√≠deo)
        let scanner;
        function iniciarScanner() {
            document.getElementById('screen-home').classList.add('hidden');
            document.getElementById('screen-scanner').classList.remove('hidden');
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
                (decoded) => {
                    scanner.stop().then(() => {
                        scanner.clear();
                        tocarDoBanco(decoded); // Usa a mesma fun√ß√£o do banco
                    });
                },
                (err) => {}
            );
        }
        function pararScanner() {
            if(scanner) scanner.stop().then(() => scanner.clear()).catch(()=>{});
            document.getElementById('screen-scanner').classList.add('hidden');
            document.getElementById('screen-home').classList.remove('hidden');
        }
        
        // Service Worker (Apenas para cachear o HTML/JS b√°sico, n√£o os v√≠deos)
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>
