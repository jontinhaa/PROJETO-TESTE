<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydro MPSA</title>
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="./manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script src="./assets/leitor.js"></script>

    <style>
        /* DESIGN SYSTEM */
        body { font-family: 'Roboto', sans-serif; background: #ffffff; color: #4a4a4a; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; }
        .container { width: 85%; max-width: 500px; padding: 30px 20px; text-align: center; }
        
        .logo-text { color: #0277bd; font-size: 1.8rem; font-weight: 700; text-transform: uppercase; border-bottom: 4px solid #81D4FA; display: inline-block; padding-bottom: 5px; margin-bottom: 30px; }

        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 8px 20px rgba(129, 212, 250, 0.25); margin-bottom: 20px; border: 1px solid #f0f0f0; }
        
        h2 { color: #0277bd; margin-top: 0; font-size: 1.4rem; }
        p { line-height: 1.6; font-size: 0.95rem; color: #666; margin-bottom: 15px; }
        
        .aviso-importante { background-color: #e3f2fd; border-left: 5px solid #2196f3; padding: 15px; text-align: left; border-radius: 4px; margin: 20px 0; color: #0d47a1; font-weight: 500; }

        .btn { background: #81D4FA; color: #014361; padding: 15px; width: 100%; border: none; border-radius: 30px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 15px; display: block; box-shadow: 0 4px 10px rgba(129, 212, 250, 0.4); transition: all 0.3s; }
        
        /* Bot√£o de Download Manual */
        .btn-download { background: #4CAF50; color: white; margin-bottom: 15px; }
        .btn-download:disabled { background: #ccc; cursor: not-allowed; }

        .btn-cancel { background: #ef5350; color: white; }
        .btn-back { background: #0277bd; color: white; }

        /* BARRA DE PROGRESSO */
        .progress-container { margin-top: 20px; text-align: left; display: none; } /* Oculto por padr√£o */
        .progress-bar-bg { width: 100%; height: 10px; background-color: #f1f1f1; border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .progress-bar-fill { height: 100%; width: 0%; background-color: #4CAF50; border-radius: 10px; transition: width 0.4s ease; }
        .loading-text { font-size: 0.85rem; color: #4CAF50; font-weight: 500; min-height: 20px; display: block; margin-top: 5px;}

        video { width: 100%; border-radius: 12px; background: #000; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; }
        .hidden { display: none !important; }
        
        .fab { position: fixed; bottom: 20px; right: 20px; background: #ef5350; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; font-weight: bold; box-shadow: 0 4px 15px rgba(239, 83, 80, 0.4); z-index: 100; font-size: 0.9rem; flex-direction: column;}
    </style>
</head>
<body>

    <a href="tel:193" class="fab"><span>üÜò</span>SOS</a>

    <div class="container">
        <div class="logo-text">Hydro MPSA</div>

        <div id="screen-home">
            <div class="card">
                <h2>Boas Vindas a Hydro MPSA!</h2>
                
                <p>Sistema de v√≠deos offline para suporte t√©cnico na planta.</p>
                
                <div class="aviso-importante">
                    ‚ö†Ô∏è <strong>Primeiro Acesso:</strong> Clique no bot√£o verde abaixo para salvar os v√≠deos no seu celular. Isso garante o funcionamento sem internet.
                </div>
                
                <button class="btn btn-download" id="btn-baixar" onclick="baixarConteudo()">‚¨áÔ∏è BAIXAR V√çDEOS OFFLINE</button>

                <div class="progress-container" id="area-progresso">
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="progress-fill"></div>
                    </div>
                    <span class="loading-text" id="status-txt">Iniciando download...</span>
                </div>

                <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

                <button class="btn" id="btn-ler" onclick="iniciarScanner()">üì∑ LER QR CODE</button>
                <div id="status-msg" style="font-size: 0.8rem; margin-top: 10px; color: #999;">Aguardando a√ß√£o...</div>
            </div>
        </div>

        <div id="screen-scanner" class="hidden">
            <div class="card">
                <h2>Escanear Equipamento</h2>
                <div id="reader"></div>
                <p style="font-size:0.8rem; color:red;" id="scan-error"></p>
                <button class="btn btn-cancel" onclick="pararScanner()">Cancelar Leitura</button>
            </div>
        </div>

        <div id="screen-video" class="hidden">
            <div class="card">
                <h2 id="video-title">Equipamento</h2>
                <video id="player" controls controlsList="nodownload"></video>
                <button class="btn btn-back" onclick="fecharVideo()">‚¨Ö Voltar ao In√≠cio</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. L√ìGICA DE DOWNLOAD FOR√áADO (A SOLU√á√ÉO) ---
        async function baixarConteudo() {
            const btn = document.getElementById('btn-baixar');
            const areaProg = document.getElementById('area-progresso');
            const barra = document.getElementById('progress-fill');
            const texto = document.getElementById('status-txt');

            btn.disabled = true;
            btn.innerText = "Conectando...";
            areaProg.style.display = "block";

            // PEGA O ENDERE√áO BASE DO SITE (Ex: https://jonathan.github.io/nexos/)
            // Remove o "index.html" se estiver l√°
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);

            // MONTA OS LINKS ABSOLUTOS (SEM ERRO DE CAMINHO)
            const videos = [
                baseUrl + 'assets/moinho.mp4',
                baseUrl + 'assets/peneira.mp4'
            ];

            // NOME DO CACHE (Tem que bater com o sw.js)
            const cacheName = 'hydro-mpsa-vFinal-Range'; 
            
            try {
                const cache = await caches.open(cacheName);
                let total = videos.length;
                let completados = 0;

                for (const url of videos) {
                    const nomeArquivo = url.split('/').pop();
                    texto.innerText = `Baixando ${nomeArquivo}...`;
                    
                    // Adiciona ?v=tempo para ignorar cache antigo
                    const urlBypass = url + "?v=" + new Date().getTime();
                    
                    try {
                        const response = await fetch(urlBypass, { cache: 'no-store' });
                        
                        if (!response.ok) {
                            // SE DER ERRO, VAI MOSTRAR NA TELA O MOTIVO EXATO
                            throw new Error(`Erro ${response.status} (${response.statusText})`);
                        }
                        
                        // Salva no cache com a URL original (limpa)
                        await cache.put(url, response.clone());
                        
                        // Salva tamb√©m a vers√£o relativa por garantia
                        await cache.put('./assets/' + nomeArquivo, response.clone());

                        completados++;
                        let pct = (completados / total) * 100;
                        barra.style.width = pct + "%";
                        
                    } catch (fetchErr) {
                        // ALERTA DE ERRO ESPEC√çFICO PARA VOC√ä VER
                        alert(`FALHA AO BAIXAR!\n\nArquivo: ${nomeArquivo}\nErro: ${fetchErr.message}\n\nLink tentado: ${url}`);
                        throw fetchErr; // Para o loop
                    }
                }

                if (completados === total) {
                    texto.innerText = "Download Conclu√≠do! ‚úÖ";
                    texto.style.color = "green";
                    btn.innerText = "Conte√∫do Salvo ‚úì";
                    btn.style.background = "#ccc";
                    alert("Sucesso! Pode desligar a internet.");
                }

            } catch (err) {
                texto.innerHTML = "Falha no download.";
                texto.style.color = "red";
                btn.disabled = false;
                btn.innerText = "Tentar Novamente";
                console.error(err);
            }
        }

        // --- 2. SISTEMA PADR√ÉO ---
        window.onload = function() {
            if (typeof Html5Qrcode === 'undefined') {
                document.getElementById('status-msg').innerHTML = "<span style='color:red'>ERRO: Leitor n√£o carregou.</span>";
            } else {
                document.getElementById('status-msg').innerHTML = "Sistema pronto.";
            }
        };

        function mostrarTela(id) {
            ['screen-home', 'screen-scanner', 'screen-video'].forEach(t => document.getElementById(t).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        let html5QrCode;
        function iniciarScanner() {
            mostrarTela('screen-scanner');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
                (decodedText) => {
                    html5QrCode.stop().then(() => { html5QrCode.clear(); rotearVideo(decodedText); });
                },
                (errorMessage) => { }
            ).catch(err => {
                document.getElementById('scan-error').innerText = "Erro C√¢mera: " + err;
            });
        }

        function pararScanner() {
            if(html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear()).catch(() => {});
            mostrarTela('screen-home');
        }

        function fecharVideo() {
            const player = document.getElementById('player');
            player.pause(); player.currentTime = 0; player.src = "";
            mostrarTela('screen-home');
        }

        function rotearVideo(texto) {
            const p = document.getElementById('player');
            const t = document.getElementById('video-title');
            const codigo = texto.toLowerCase();

            if (codigo.includes('moinho')) {
                t.innerText = "Moinho Prim√°rio 01";
                p.src = "./assets/moinho.mp4";
                mostrarTela('screen-video');
                p.play();
            } else if (codigo.includes('peneira')) {
                t.innerText = "Peneira Vibrat√≥ria";
                p.src = "./assets/peneira.mp4";
                mostrarTela('screen-video');
                p.play();
            } else {
                alert("QR Code n√£o reconhecido.\nLeitura: " + texto);
                mostrarTela('screen-home');
            }
        }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>



